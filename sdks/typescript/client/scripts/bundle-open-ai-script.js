import { build } from 'esbuild';
import { writeFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

try {
  const result = await build({
    entryPoints: [join(__dirname, '../../client/src/adapters/appssdk/open-ai-runtime-script.ts')],
    bundle: true,
    write: false,
    format: 'iife',
    platform: 'browser',
    target: 'es2020',
    minify: false,
  });

  const bundledCode = result.outputFiles[0].text;
  const serializedCode = JSON.stringify(bundledCode);

  const outputContent = `// This file is auto-generated by scripts/bundle-open-ai-script.js
// Do not edit directly - modify client/src/adapters/appssdk/open-ai-runtime-script.ts instead

export const API_RUNTIME_SCRIPT = ${serializedCode};
`;

  const outputTsPath = join(__dirname, '../../client/src/adapters/appssdk/open-ai-runtime-script.bundled.ts');
  writeFileSync(outputTsPath, outputContent);
  console.log('✅ Successfully bundled API runtime script');
} catch (error) {
  console.error('❌ Failed to bundle API runtime script:', error);
  process.exit(1);
}
